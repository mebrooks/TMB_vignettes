---
title: "Simulate from a Fitted TMB Model"
author: "Mollie Brooks"
date: "2 November 2016"
output: pdf_document
---

First we simulate data for the process we're modeling. Assume that we observe values of `y` on different dates in a control unit `trt=0` and in another experimental unit that was treated in some way `trt=1`. The baseline mean of the control unit is `mu` and the treatment effect (`trt_eff`) adds to that mean.

```{r}
library(TMB)
mu=5
trt_eff=10
dev_date=rnorm(ndates, 0, date_sd)#random effect of date
date_sd=3
resid_sd=1
ndates=30
dat=expand.grid(date=factor(1:ndates), trt=c(0,1))
dat0=transform(dat, y=mu+trt_eff*trt + dev_date[date])
dat0$y=dat0$y+rnorm(nrow(dat0),0,resid_sd)
X=model.matrix(~-1+trt, data=dat0)#fixed effects
Z=model.matrix(~-1+date, data=dat0)#random effects
```

```{#numCode .Cpp .numberLines}
#include <TMB.hpp>                                
template<class Type>
Type objective_function<Type>::operator() ()
{
    DATA_VECTOR(y);
    DATA_MATRIX(X);                             
    DATA_MATRIX(Z);
    PARAMETER(log_re_sd);
    Type re_sd=exp(log_re_sd);
    ADREPORT(re_sd);
    PARAMETER(log_resid_sd);
    Type resid_sd=exp(log_resid_sd);
    ADREPORT(resid_sd);
    PARAMETER_VECTOR(beta);
    PARAMETER_VECTOR(dev);
    
    //CALCULATE NEGATIVE LOG LIKELIHOOD
    Type nll;       
    vector<Type> Xbeta= X*beta;
    vector<Type> Zdev= Z*dev;
    for(int i=0; i<y.size(); i++)
    {
        nll-= dnorm(y(i), Xbeta(i)+Zdev(i), resid_sd, true);
    }
    for(int i=0; i<dev.size(); i++)
    {
        nll-= dnorm(dev(i), Type(0), re_sd, true);
    }           
    return nll;
}
```

```{r}
compile("FE.cpp", "-g -O0")
dyn.load("FE.so")
obj=MakeADFun(data=list(y=dat0$y, X=X, Z=Z, ntraps=ntraps),
            parameters=list(log_re_sd=0, log_resid_sd=1, beta=rep(0, ncol(X)), dev=rep(0, ncol(Z))),
            random=c("dev"), DLL="FE")
opt = nlminb(obj $par, obj $fn, obj $gr)
sdr=sdreport(obj) 
sdr
